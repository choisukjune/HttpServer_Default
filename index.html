<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Sample Site</title>


    <script src="https://code.jquery.com/jquery-3.5.1.js" integrity="sha256-QWo7LDvxbWT2tbbQ97B53yJnYU3WhH/C8ycbRAkjPDc=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.4.1/semantic.min.js"></script>

    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.4.1/semantic.min.css">
    <style>
    body { padding:0px; }
    table{
        width : 100%;
        background-color : #ccc
    }
    tr{ margin : 1px; }
    td{
        border : 0px solid #ccc;
        padding: 3px;
        background-color : #fff;
        font-size :11px;
    }
    </style>
    <script>
    var htmlToElement = function(html) {
        var template = document.createElement('template');
        html = html.trim(); // Never return a text node of whitespace as the result
        template.innerHTML = html;
        var r = {
            cnt : template.content.children.length
            , data : template.content
        }
        
        return r;
    }
    
    var getRequest = function( url,cbFunction ){
        var xhr = new XMLHttpRequest();
        xhr.onreadystatechange = function() { // 요청에 대한 콜백
        if (xhr.readyState === xhr.DONE) { // 요청이 완료되면
            if (xhr.status === 200 || xhr.status === 201) {
            //   console.log();
                cbFunction( xhr.responseText )
            } else {
            console.error(xhr.responseText);
            }
        }
        };
        xhr.open('GET', url ); // 메소드와 주소 설정
        xhr.send(); // 요청 전송 
        // xhr.abort(); // 전송된 요청 취소

    }

    var getScroll = function(){ 
            
        if ( window.pageYOffset != undefined ) { 
            // console.log( " X-axis : " + pageXOffset + " Y-axis : " + pageYOffset )
            return pageYOffset;
        } else { 
            var x_axis, y_axis, doc = document, 
                ele = doc.documentElement, 
                b = doc.body; 
            x_axis = ele.scrollLeft || b.scrollLeft || 0; 
            y_axis = ele.scrollTop || b.scrollTop || 0; 
            // console.log( " X-axis : " + pageXOffset + " Y-axis : " + pageYOffset )
            return pageYOffset;
        } 
    } 

    window.SERVER = {};
    window.SERVER.HTTPSERVER = {};
    window.SERVER.HTTPSERVER.HOST = "http://localhost";
    window.SERVER.HTTPSERVER.PORT = 3000;
    window.SERVER.HTTPSERVER.URL = window.SERVER.HTTPSERVER.HOST + ":" + window.SERVER.HTTPSERVER.PORT;
    window.HTML = {};
    window.HTML.list = {};
    window.HTML.list.data = [];
    window.HTML.list.cnt = 0;

    window.addEventListener('DOMContentLoaded', (e) => {
        console.log('DOM fully loaded and parsed');
        getRequest( window.SERVER.HTTPSERVER.URL + "/html/getFileCount", function(d){
            window.HTML.list.data = JSON.parse( d );
            debugger;
            getRequest( window.SERVER.HTTPSERVER.URL + "/html/" + window.HTML.list.data[ window.HTML.list.cnt ], function(d){
                var a = window.document.getElementsByClassName( "cards" )[0]
                var data = htmlToElement( d )
                debugger;
                a.appendChild( data.data )
                if( data.cnt < 24 )
                {
                    getNextData();
                }

            })
        })
        var msgFNS = {
            message : function( o ){
                console.log( o.data );
                return;
            }
            , render : function( o ){
                var a = window.document.getElementsByClassName( "cards" )[0];
                var data = htmlToElement( o.data );
                
                //*/
                a.insertBefore(data.data, a.childNodes[0]);
                /*/
                a.appendChild( data.data )
                //*/
                return;
            }
        };
        
        var ws = new WebSocket(`ws://${location.host}`);
        ws.onmessage = function(e) {
            var msg = JSON.parse( e.data );
            msgFNS[ msg.type ]( msg );
        };     
    });
    //
    var getNextData = function(){
        
        if(  window.HTML.list.data.length == window.HTML.list.cnt + 1 )
        {
            window.removeEventListener( 'scroll', getNextData );
            alert( "더이상 데이터가 존재하지 않습니다." )
        }
        else
        {

            ++window.HTML.list.cnt;
            getRequest( window.SERVER.HTTPSERVER.URL + "/html/" + window.HTML.list.data[ window.HTML.list.cnt ], function(d){
                var a = window.document.getElementsByClassName( "cards" )[0]
                var data = htmlToElement( d )
                a.appendChild( data.data )
                if( data.cnt < 8 )
                {
                    getNextData();
                }
            })
        }
    };

    var scrollToGetNextData = function(){
        
        if(  window.HTML.list.data.length == window.HTML.list.cnt + 1 )
        {
            window.removeEventListener( 'scroll', scrollToGetNextData );
            alert( "더이상 데이터가 존재하지 않습니다." )
        }
        if( (document.documentElement.scrollTop + window.innerHeight + 500 ) >= document.documentElement.scrollHeight )
        {
            getNextData()
        }
    };
    

    window.addEventListener('scroll', scrollToGetNextData );
    </script>
    <body>
        <div class="ui  grid">
            <div class="sixteen wide column" style="padding:50px;">
                <div class="ui eight stackable cards">
                </div>
            </div>
        </div>
    </body>
</html>